rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------
    // Helpers
    // -------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function userDocPath() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function hasUserDoc() {
      return isSignedIn() && exists(userDocPath());
    }

    function userDoc() {
      return get(userDocPath());
    }

    // Compat: antes usabas users.hostelSlug, ahora activeHostelSlug
    function activeHostelSlug() {
      return hasUserDoc()
        ? (userDoc().data.activeHostelSlug != null
            ? userDoc().data.activeHostelSlug
            : userDoc().data.hostelSlug)
        : null;
    }

    function isNonEmptyString(v, minLen) {
      return v is string && v.size() >= minLen;
    }

    function memberPath(hostelSlug) {
      return /databases/$(database)/documents/hostels/$(hostelSlug)/members/$(request.auth.uid);
    }

    function isMember(hostelSlug) {
      return isSignedIn() && exists(memberPath(hostelSlug));
    }

    function memberRole(hostelSlug) {
      return isMember(hostelSlug) ? get(memberPath(hostelSlug)).data.role : "guest";
    }

    function isStaffPlus(hostelSlug) {
      return isMember(hostelSlug) && memberRole(hostelSlug) in ["owner", "manager", "staff"];
    }

    function isManagerPlus(hostelSlug) {
      return isMember(hostelSlug) && memberRole(hostelSlug) in ["owner", "manager"];
    }

    // -------------------------
    // USERS
    // -------------------------
    match /users/{uid} {
      allow read: if isSignedIn() && request.auth.uid == uid;

      // Bootstrap: el user puede crear su doc, pero SIN roles.
      allow create: if isSignedIn()
        && request.auth.uid == uid
        && request.resource.data.keys().hasOnly(["activeHostelSlug", "createdAt", "email"])
        && ( !("activeHostelSlug" in request.resource.data)
             || request.resource.data.activeHostelSlug == null
             || isNonEmptyString(request.resource.data.activeHostelSlug, 2) );

      // No permitir que el cliente agregue campos raros.
      allow update: if isSignedIn()
        && request.auth.uid == uid
        && resource.data.keys().hasOnly(["activeHostelSlug", "createdAt", "email"])
        && request.resource.data.keys().hasOnly(["activeHostelSlug", "createdAt", "email"]);

      allow delete: if false;
    }

    // -------------------------
    // HOSTELS
    // -------------------------
    match /hostels/{hostelSlug} {
      // público
      allow read: if true;

     // Crear hostel: SOLO backend (Functions/Admin SDK)
allow create: if false;

      // Actualizar hostel: manager+
      allow update: if isManagerPlus(hostelSlug)
        && request.resource.data.ownerUid == resource.data.ownerUid
        && request.resource.data.slug == resource.data.slug;

      allow delete: if false;

      // -------------------------
      // MEMBERS
      // -------------------------
      match /members/{memberUid} {
        // Cada miembro puede leer su doc; manager+ puede listar/ver miembros
        allow read: if (isSignedIn() && request.auth.uid == memberUid)
          || isManagerPlus(hostelSlug);

        // Nadie escribe desde cliente (solo Functions Admin SDK)
        allow create, update, delete: if false;
      }

      // -------------------------
      // ROOMS
      // -------------------------
      match /rooms/{roomId} {
        function validRoom() {
          return request.resource.data.keys().hasAll(["name", "price", "capacity"])
            && isNonEmptyString(request.resource.data.name, 2)
            && (request.resource.data.price is int || request.resource.data.price is number)
            && request.resource.data.price > 0
            && (request.resource.data.capacity is int || request.resource.data.capacity is number)
            && request.resource.data.capacity >= 1
            && (!("description" in request.resource.data) || request.resource.data.description is string)
            && (!("imageUrls" in request.resource.data) || request.resource.data.imageUrls is list)
            && (!("imagePaths" in request.resource.data) || request.resource.data.imagePaths is list);
        }

        allow read: if true;

        // staff+ puede operar rooms (si querés restringir más: manager+)
        allow create: if isStaffPlus(hostelSlug) && validRoom();
        allow update: if isStaffPlus(hostelSlug) && validRoom();
        allow delete: if isManagerPlus(hostelSlug);
      }

      // -------------------------
      // RESERVATIONS (solo admin panel)
      // -------------------------
      match /reservations/{reservationId} {
        allow read: if isStaffPlus(hostelSlug);
        allow create, update, delete: if false; // solo backend
      }

      // -------------------------
      // EMAIL LOGS
      // -------------------------
      match /email_logs/{logId} {
        allow read: if isManagerPlus(hostelSlug);
        allow create, update, delete: if false; // solo backend
      }

      // -------------------------
      // LOCKS
      // -------------------------
      match /room_nights/{lockId} {
        allow read: if false;
        allow create, update, delete: if false;
      }

      // deny unknown subcollections
      match /{document=**} {
        allow read, write: if false;
      }
    }

    // deny by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}